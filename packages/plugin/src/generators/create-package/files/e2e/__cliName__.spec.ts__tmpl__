import { getPackageManagerCommand } from '@nx/devkit';
import {
  checkFilesExist,
  removeTmpProject,
  tmpFolder,
  uniq,
} from '@nx/plugin/testing';
import { execSync } from 'child_process';
import { join } from 'path';

describe('<%= cliName %> e2e', () => {
  let project: string;
  beforeAll(async () => {
    // publish plugin and cli
    const pm = getPackageManagerCommand();
    execSync(`${pm.exec} nx publish <%= pluginName %> --ver=1.0.0 --tag=e2e`, {
      env: process.env,
    });
    execSync(`${pm.exec} nx publish <%= cliName %> --ver=1.0.0 --tag=e2e`, {
      env: process.env,
    });
    project = uniq('<%= cliName %>');
    execSync(`npx <%= cliName %>@1.0.0 ${project}`, {
      cwd: tmpFolder(),
      env: process.env,
    });
  }, 240_000);

  afterAll(() => {
    // Remove the generated project from the file system
    removeTmpProject(project);
  });

  it('should create project using <%= cliName %>', () => {
    expect(() =>
      checkFilesExist(join(tmpFolder(), project, 'package.json'))
    ).not.toThrow();
  });
});
